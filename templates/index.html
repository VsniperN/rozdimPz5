<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Система обігріву приміщення</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="container mt-5">
    <h1 class="text-center mb-4">Система обігріву приміщення</h1>
    <div class="row mb-3">
        <div class="col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Поточна температура:</h5>
                    <p class="card-text"><span id="temperature">{{ temperature }} °C</span></p>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Стан системи опалення:</h5>
                    <p class="card-text"><span id="heating_on">{{ 'УВІМКНЕНО' if heating_on else 'ВИМКНЕНО' }}</span></p>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Нижній поріг (N1):</h5>
                    <p class="card-text"><span id="lower_threshold">{{ lower_threshold }} °C</span></p>
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Верхній поріг (N2):</h5>
                    <p class="card-text"><span id="upper_threshold">{{ upper_threshold }} °C</span></p>
                </div>
            </div>
        </div>
    </div>
    <hr class="mb-4">
    <h2 class="text-center mb-3">Оновити пороги</h2>
    <form id="thresholdForm">
        <div class="form-group row">
            <label for="lower_threshold" class="col-sm-3 col-form-label">Нижній поріг (N1):</label>
            <div class="col-sm-6">
                <input type="number" class="form-control" id="lower_threshold_input" name="lower_threshold" step="0.1" required>
            </div>
        </div>
        <div class="form-group row">
            <label for="upper_threshold" class="col-sm-3 col-form-label">Верхній поріг (N2):</label>
            <div class="col-sm-6">
                <input type="number" class="form-control" id="upper_threshold_input" name="upper_threshold" step="0.1" required>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-9 offset-sm-3">
                <button type="submit" class="btn btn-primary">Оновити</button>
            </div>
        </div>
    </form>
    <hr class="mb-4">
    <h2 class="text-center mb-3">Графік температури</h2>
    <canvas id="temperatureChart" width="600" height="400"></canvas>
</div>
<script>
    document.getElementById('thresholdForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const lowerThreshold = document.getElementById('lower_threshold_input').value;
        const upperThreshold = document.getElementById('upper_threshold_input').value;
        fetch('/update_thresholds', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ lower_threshold: lowerThreshold, upper_threshold: upperThreshold }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Пороги успішно оновлено');
                updateThresholdsDisplay(lowerThreshold, upperThreshold);
            } else {
                alert('Сталася помилка під час оновлення порогів');
            }
        });
    });

    function updateThresholdsDisplay(lower, upper) {
        document.getElementById('lower_threshold').innerText = lower + ' °C';
        document.getElementById('upper_threshold').innerText = upper + ' °C';
    }

    let temperatureChart;
    const temperatureChartCtx = document.getElementById('temperatureChart').getContext('2d');

    function updateTemperatureChart(data) {
        const labels = data.map(entry => entry.timestamp);
        const temperatures = data.map(entry => entry.temperature);
        if (temperatureChart) {
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = temperatures;
            temperatureChart.update();
        } else {
            temperatureChart = new Chart(temperatureChartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Температура',
                        data: temperatures,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }
    }

    setInterval(() => {
        fetch('/temperature')
        .then(response => response.json())
        .then(data => {
            document.getElementById('temperature').innerText = data.temperature.toFixed(2) + ' °C';
            document.getElementById('heating_on').innerText = data.heating_on ? 'УВІМКНЕНО' : 'ВИМКНЕНО';
            document.getElementById('lower_threshold').innerText = data.lower_threshold + ' °C';
            document.getElementById('upper_threshold').innerText = data.upper_threshold + ' °C';
            updateTemperatureChart(data.temperature_data);
        });
    }, 2000);
</script>
</body>
</html>
